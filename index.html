<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω Qu·ªπ L·ªõp 1C</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #007bff; --danger: #dc3545; --success: #28a745; --warning: #ffc107; --light: #f8f9fa; --purple: #6f42c1; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; font-size: 16px; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; background: white; min-height: 100vh; box-sizing: border-box; }
        .nav { display: flex; justify-content: space-between; background: #fff; padding: 10px 0; border-bottom: 2px solid #eee; position: sticky; top: 0; z-index: 100; overflow-x: auto; }
        .nav button { border: none; background: none; padding: 10px 8px; font-weight: bold; color: #666; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .nav button.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .section { display: none; padding-top: 15px; }
        .section.active { display: block; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        button.btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 5px; font-weight: bold; }
        .summary-box { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; text-align: center; }
        .list-item { background: #fff; border: 1px solid #eee; padding: 12px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .list-item.highlight { border: 2px solid var(--danger); background-color: #fff5f5; }
        .info b { color: #333; font-size: 15px; }
        .info small { color: #666; display: block; }
        .actions button { padding: 6px 10px; border-radius: 4px; border: none; font-size: 12px; cursor: pointer; }

        /* Style cho danh s√°ch g·ª£i √Ω t√πy ch·ªânh */
        .suggestion-wrapper { position: relative; }
        .custom-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; z-index: 1000; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; margin-top: -10px; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f0f7ff; }
        .duplicate-alert { color: var(--danger); font-size: 13px; font-weight: bold; margin-bottom: 10px; display: none; }

        #previewArea { border: 1px solid #ccc; padding: 15px; margin-top: 10px; background: #fff; overflow-x: auto; }
        .print-table-preview { width: 100%; border-collapse: collapse; font-family: "Times New Roman", serif; font-size: 12pt; background: #fff; }
        .print-table-preview th, .print-table-preview td { border: 1px solid #000; padding: 5px; color: #000; }
        .header-preview { text-align: center; font-weight: bold; font-size: 14pt; margin-bottom: 10px; text-transform: uppercase; font-family: "Times New Roman", serif; color: #000; }
        .expense-box { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff5f5; margin-bottom: 15px; }
        .balance-box { background: #d4edda; border: 1px solid #c3e6cb; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        .balance-box b { font-size: 20px; color: #155724; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button onclick="switchTab('tab-students')" id="btn-students" class="active">H·ªçc Sinh</button>
        <button onclick="switchTab('tab-campaigns')" id="btn-campaigns">ƒê·ª£t ·ª¶ng H·ªô</button>
        <button onclick="switchTab('tab-donate')" id="btn-donate">Nh·∫≠p Ti·ªÅn</button>
        <button onclick="switchTab('tab-expenses')" id="btn-expenses">Chi Ti√™u</button>
        <button onclick="switchTab('tab-print')" id="btn-print">B·∫£n In</button>
        <button onclick="switchTab('tab-settings')" id="btn-settings">C√†i ƒê·∫∑t</button>
    </div>

    <div id="tab-students" class="section active">
        <input type="search" id="searchStd" placeholder="üîç T√¨m ki·∫øm t√™n h·ªçc sinh..." oninput="renderStudents()">
        <div style="border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa;">
            <input type="text" id="stdName" placeholder="H·ªç t√™n h·ªçc sinh (B·∫Øt bu·ªôc)">
            <input type="text" id="stdFather" placeholder="H·ªç t√™n B·ªë">
            <input type="text" id="stdMother" placeholder="H·ªç t√™n M·∫π">
            <button class="btn" onclick="addStudent()">Th√™m v√†o danh s√°ch l·ªõp</button>
        </div>
        <p><b>Sƒ© s·ªë: <span id="countStd">0</span></b></p>
        <div id="studentListDisplay"></div>
    </div>

    <div id="tab-campaigns" class="section">
        <input type="text" id="campName" placeholder="T√™n ƒë·ª£t (VD: ·ªßng h·ªô trung thu)">
        <button class="btn" style="background:var(--success)" onclick="addCampaign()">T·∫°o danh s√°ch m·ªõi</button>
        <hr>
        <div id="campaignListDisplay"></div>
    </div>

    <div id="tab-donate" class="section">
        <label>Ch·ªçn ƒë·ª£t ·ªßng h·ªô:</label>
        <select id="donateCampaignSelect" onchange="renderRecentDonations()"></select>
        <div style="border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff;">
            <div id="dupAlert" class="duplicate-alert">‚ö†Ô∏è T√™n n√†y ƒë√£ c√≥ trong danh s√°ch ·ªßng h·ªô!</div>
            <div class="suggestion-wrapper">
                <input type="text" id="donateName" placeholder="Nh·∫≠p t√™n h·ªçc sinh..." oninput="handleDonateNameInput()" onfocus="handleDonateNameInput()">
                <div id="customSuggestions" class="custom-suggestions"></div>
            </div>
            <input type="tel" id="donateAmount" placeholder="S·ªë ti·ªÅn (VD: 100.000)" onkeyup="formatCurrencyInput(this)">
            <button class="btn" onclick="addDonation()">Ghi nh·∫≠n ·ªßng h·ªô</button>
        </div>
        <div class="summary-box">
            <div><small>Ng∆∞·ªùi ƒë√≥ng</small><br><b id="sumCount">0</b></div>
            <div><small>T·ªïng ti·ªÅn</small><br><b id="sumMoney" style="color:var(--success)">0 ƒë</b></div>
        </div>
        <div id="recentDonations"></div>
    </div>

    <div id="tab-expenses" class="section">
        <label>Ch·ªçn ƒë·ª£t ƒë·ªÉ qu·∫£n l√Ω chi ti√™u:</label>
        <select id="expenseCampaignSelect" onchange="renderExpenses()"></select>
        <div class="balance-box">
            <small>S·ªê D∆Ø C·ª¶A ƒê·ª¢T N√ÄY</small><br>
            <b id="finalBalance">0 ƒë</b>
        </div>
        <div class="expense-box">
            <input type="date" id="expDate">
            <input type="text" id="expTitle" placeholder="Kho·∫£n chi (B·∫Øt bu·ªôc)">
            <input type="tel" id="expAmount" placeholder="S·ªë ti·ªÅn chi (B·∫Øt bu·ªôc)" onkeyup="formatCurrencyInput(this)">
            <button class="btn" style="background:var(--purple)" onclick="addExpense()">L∆∞u kho·∫£n chi</button>
        </div>
        <div class="summary-box" style="background: #fff0f0;">
            <div><small>T·ªïng chi ƒë·ª£t n√†y</small><br><b id="sumExpense" style="color:var(--danger)">0 ƒë</b></div>
        </div>
        <div id="expenseListDisplay"></div>
    </div>

    <div id="tab-print" class="section">
        <label>Ch·ªçn danh s√°ch:</label>
        <select id="printCampaignSelect" onchange="renderPrintPreview()"></select>
        <label>Lo·∫°i danh s√°ch:</label>
        <select id="printTypeSelect" onchange="renderPrintPreview()">
            <option value="donate">Danh s√°ch Thu (·ª¶ng h·ªô)</option>
            <option value="expense">Danh s√°ch Chi ti√™u</option>
        </select>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn" onclick="printData()" style="background:#333">üñ®Ô∏è IN / XU·∫§T PDF</button>
            <button class="btn" onclick="downloadImage()" style="background:var(--success)">üì∏ XU·∫§T ·∫¢NH (.JPG)</button>
        </div>
        <div id="previewArea">
            <div id="printContent" style="background: white; padding: 10px;"></div>
        </div>
    </div>

    <div id="tab-settings" class="section">
        <button class="btn" style="background:var(--warning); color:#333" onclick="backupData()">‚¨áÔ∏è Sao l∆∞u d·ªØ li·ªáu (.txt)</button>
        <hr>
        <label>N·∫°p d·ªØ li·ªáu t·ª´ file .txt ho·∫∑c .json:</label>
        <input type="file" id="fileInput" accept=".txt,.json">
        <button class="btn" style="background:var(--danger)" onclick="restoreData()">‚¨ÜÔ∏è Kh√¥i ph·ª•c (Restore)</button>
    </div>
</div>

<script>
    let students = JSON.parse(localStorage.getItem('students')) || [];
    let campaigns = JSON.parse(localStorage.getItem('campaigns')) || [];
    let donations = JSON.parse(localStorage.getItem('donations')) || [];
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];

    function toTitleCase(str) {
        if (!str) return "";
        return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }
    function formatMoney(n) { return new Intl.NumberFormat('vi-VN').format(n); }
    function getRawMoney(str) { return parseInt(String(str).replace(/\D/g, '')) || 0; }
    function formatCurrencyInput(input) {
        let v = input.value.replace(/\D/g, "");
        input.value = v ? parseInt(v).toLocaleString("vi-VN") : "";
    }

    function switchTab(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('btn-' + id.split('-')[1]).classList.add('active');
        if(id === 'tab-students') renderStudents();
        if(id === 'tab-campaigns') renderCampaigns();
        if(id === 'tab-donate') prepareDonateTab();
        if(id === 'tab-expenses') prepareExpenseTab();
        if(id === 'tab-print') preparePrintTab();
    }

    // --- QU·∫¢N L√ù H·ªåC SINH ---
    function addStudent() {
        let name = toTitleCase(document.getElementById('stdName').value.trim());
        let f = toTitleCase(document.getElementById('stdFather').value.trim());
        let m = toTitleCase(document.getElementById('stdMother').value.trim());
        if(!name) return alert("T√™n HS kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng");
        students.push({ id: Date.now(), name, father: f, mother: m });
        students.sort((a,b) => a.name.localeCompare(b.name));
        localStorage.setItem('students', JSON.stringify(students));
        document.querySelectorAll('#tab-students input').forEach(i => i.value = '');
        renderStudents();
    }
    function renderStudents() {
        let search = document.getElementById('searchStd').value.toLowerCase();
        let list = students.filter(s => s.name.toLowerCase().includes(search));
        let html = list.map(s => `
            <div class="list-item">
                <div class="info"><b>${s.name}</b><small>B·ªë: ${s.father||'--'} | M·∫π: ${s.mother||'--'}</small></div>
                <div class="actions"><button style="background:var(--danger);color:white" onclick="deleteStudent(${s.id})">X√≥a</button></div>
            </div>`).join('');
        document.getElementById('studentListDisplay').innerHTML = html;
        document.getElementById('countStd').innerText = students.length;
    }
    function deleteStudent(id) {
        if(confirm("X√≥a h·ªçc sinh n√†y?")) {
            students = students.filter(s => s.id !== id);
            localStorage.setItem('students', JSON.stringify(students));
            renderStudents();
        }
    }

    // --- ƒê·ª¢T ·ª¶NG H·ªò ---
    function addCampaign() {
        let name = document.getElementById('campName').value.trim().toUpperCase();
        if(!name) return alert("Nh·∫≠p t√™n danh s√°ch");
        campaigns.push({ id: Date.now(), name });
        localStorage.setItem('campaigns', JSON.stringify(campaigns));
        document.getElementById('campName').value = '';
        renderCampaigns();
    }
    function renderCampaigns() {
        document.getElementById('campaignListDisplay').innerHTML = campaigns.map(c => `
            <div class="list-item">
                <b>${c.name}</b>
                <button style="background:var(--danger);color:white" onclick="deleteCampaign(${c.id})">X√≥a</button>
            </div>`).join('');
    }
    function deleteCampaign(id) {
        if(confirm("X√≥a ƒë·ª£t n√†y? T·∫•t c·∫£ d·ªØ li·ªáu thu v√† chi li√™n quan s·∫Ω b·ªã x√≥a.")) {
            campaigns = campaigns.filter(c => c.id !== id);
            donations = donations.filter(d => d.campaignId != id);
            expenses = expenses.filter(e => e.campaignId != id);
            localStorage.setItem('campaigns', JSON.stringify(campaigns));
            localStorage.setItem('donations', JSON.stringify(donations));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderCampaigns();
        }
    }

    // --- NH·∫¨P TI·ªÄN (Ph·∫ßn ch·ªânh s·ª≠a) ---
    function prepareDonateTab() {
        let sel = document.getElementById('donateCampaignSelect');
        sel.innerHTML = campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if(campaigns.length) sel.value = campaigns[campaigns.length-1].id;
        renderRecentDonations();
    }

    function handleDonateNameInput() {
        let val = document.getElementById('donateName').value.toLowerCase();
        let suggestions = document.getElementById('customSuggestions');
        
        if (val.length < 1) {
            suggestions.style.display = 'none';
            checkAndHighlightDuplicate();
            return;
        }

        let matches = students.filter(s => s.name.toLowerCase().includes(val));
        if (matches.length > 0) {
            suggestions.innerHTML = matches.map(s => `
                <div class="suggestion-item" onclick="selectSuggestion('${s.name}')">
                    ${s.name} <small style="color:#888">(B·ªë: ${s.father||'?'})</small>
                </div>
            `).join('');
            suggestions.style.display = 'block';
        } else {
            suggestions.style.display = 'none';
        }
        checkAndHighlightDuplicate();
    }

    function selectSuggestion(name) {
        document.getElementById('donateName').value = name;
        document.getElementById('customSuggestions').style.display = 'none';
        checkAndHighlightDuplicate();
    }

    // ƒê√≥ng g·ª£i √Ω khi b·∫•m ra ngo√†i
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.suggestion-wrapper')) {
            document.getElementById('customSuggestions').style.display = 'none';
        }
    });

    function checkAndHighlightDuplicate() {
        let name = toTitleCase(document.getElementById('donateName').value.trim());
        let campId = document.getElementById('donateCampaignSelect').value;
        let found = donations.find(d => d.campaignId == campId && d.studentName === name);
        
        document.getElementById('dupAlert').style.display = found ? 'block' : 'none';
        renderRecentDonations(found ? found.id : null);
    }

    function addDonation() {
        let campId = document.getElementById('donateCampaignSelect').value;
        let name = toTitleCase(document.getElementById('donateName').value.trim());
        let amt = getRawMoney(document.getElementById('donateAmount').value);
        if(!campId) return alert("Vui l√≤ng t·∫°o m·ªôt ƒë·ª£t ·ªßng h·ªô tr∆∞·ªõc.");
        if(!name || amt <= 0) return alert("Nh·∫≠p ƒë·ªß t√™n v√† s·ªë ti·ªÅn");
        
        let idx = donations.findIndex(d => d.campaignId == campId && d.studentName === name);
        if(idx >= 0) {
            if(!confirm("H·ªçc sinh n√†y ƒë√£ ·ªßng h·ªô r·ªìi. B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t l·∫°i s·ªë ti·ªÅn m·ªõi kh√¥ng?")) return;
            donations[idx].amount = amt;
        } else {
            donations.push({ id: Date.now(), campaignId: campId, studentName: name, amount: amt });
        }
        localStorage.setItem('donations', JSON.stringify(donations));
        document.getElementById('donateName').value = '';
        document.getElementById('donateAmount').value = '';
        document.getElementById('dupAlert').style.display = 'none';
        renderRecentDonations();
    }

    function renderRecentDonations(highId = null) {
        let campId = document.getElementById('donateCampaignSelect').value;
        if(!campId) return;
        
        let list = donations.filter(d => d.campaignId == campId).reverse();
        
        // ƒê·∫©y t√™n tr√πng l√™n tr√™n c√πng
        if(highId) {
            let i = list.findIndex(d => d.id === highId);
            if(i > -1) { 
                let item = list.splice(i, 1)[0]; 
                list.unshift(item); 
            }
        }
        
        let totalMoney = 0;
        let html = list.map(d => {
            totalMoney += d.amount;
            let origin = students.find(s => s.name === d.studentName);
            let pInfo = origin ? `(B·ªë: ${origin.father||'?'}, M·∫π: ${origin.mother||'?'})` : "(Ngo√†i danh s√°ch)";
            return `<div class="list-item ${d.id === highId ? 'highlight' : ''}">
                <div class="info">
                    <b>${d.studentName}</b>
                    <small>${pInfo}</small>
                    <b style="color:var(--success)">${formatMoney(d.amount)} ƒë</b>
                    ${d.id === highId ? '<small style="color:red; font-weight:bold">ƒê√É C√ì TRONG DANH S√ÅCH</small>' : ''}
                </div>
                <button style="color:red;border:1px solid red;background:none;padding:5px;border-radius:4px" onclick="deleteDonation(${d.id})">X√≥a</button>
            </div>`;
        }).join('');
        
        document.getElementById('recentDonations').innerHTML = html;
        document.getElementById('sumCount').innerText = list.length;
        document.getElementById('sumMoney').innerText = formatMoney(totalMoney) + " ƒë";
    }

    function deleteDonation(id) {
        if(confirm("X√≥a m·ª•c n√†y?")) {
            donations = donations.filter(d => d.id !== id);
            localStorage.setItem('donations', JSON.stringify(donations));
            renderRecentDonations();
        }
    }

    // --- CHI TI√äU ---
    function prepareExpenseTab() {
        let sel = document.getElementById('expenseCampaignSelect');
        sel.innerHTML = campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if(campaigns.length) sel.value = campaigns[campaigns.length-1].id;
        renderExpenses();
    }
    function addExpense() {
        let campId = document.getElementById('expenseCampaignSelect').value;
        let date = document.getElementById('expDate').value;
        let title = document.getElementById('expTitle').value.trim();
        let amt = getRawMoney(document.getElementById('expAmount').value);
        if(!campId) return alert("Vui l√≤ng ch·ªçn ƒë·ª£t ·ªßng h·ªô.");
        if(!title || amt <= 0) return alert("Vui l√≤ng nh·∫≠p kho·∫£n chi v√† s·ªë ti·ªÅn!");
        expenses.push({ id: Date.now(), campaignId: campId, date, title, amount: amt });
        localStorage.setItem('expenses', JSON.stringify(expenses));
        document.getElementById('expTitle').value = '';
        document.getElementById('expAmount').value = '';
        renderExpenses();
    }
    function renderExpenses() {
        let campId = document.getElementById('expenseCampaignSelect').value;
        if(!campId) return;
        let curDons = donations.filter(d => d.campaignId == campId);
        let curExps = expenses.filter(e => e.campaignId == campId);
        let totalIn = curDons.reduce((sum, d) => sum + d.amount, 0);
        let totalOut = curExps.reduce((sum, e) => sum + e.amount, 0);
        document.getElementById('expenseListDisplay').innerHTML = curExps.slice().reverse().map(e => `
            <div class="list-item">
                <div class="info"><b>${e.title}</b><small>${e.date || ''}</small><b style="color:var(--danger)">- ${formatMoney(e.amount)} ƒë</b></div>
                <button style="color:red;border:1px solid red;background:none;padding:5px;border-radius:4px" onclick="deleteExpense(${e.id})">X√≥a</button>
            </div>`).join('');
        document.getElementById('sumExpense').innerText = formatMoney(totalOut) + " ƒë";
        document.getElementById('finalBalance').innerText = formatMoney(totalIn - totalOut) + " ƒë";
    }
    function deleteExpense(id) {
        if(confirm("X√≥a kho·∫£n chi n√†y?")) {
            expenses = expenses.filter(e => e.id !== id);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            renderExpenses();
        }
    }

    // --- B·∫¢N IN & XU·∫§T ·∫¢NH ---
    function preparePrintTab() {
        let sel = document.getElementById('printCampaignSelect');
        sel.innerHTML = campaigns.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        if(campaigns.length) sel.value = campaigns[campaigns.length-1].id;
        renderPrintPreview();
    }
    function renderPrintPreview() {
        let cid = document.getElementById('printCampaignSelect').value;
        let type = document.getElementById('printTypeSelect').value;
        if(!cid) return;
        let camp = campaigns.find(c => c.id == cid);
        let html = '';
        let total = 0;

        if(type === 'donate') {
            let list = donations.filter(d => d.campaignId == cid).sort((a,b) => a.id - b.id);
            let rows = list.map((d, i) => {
                total += d.amount;
                return `<tr><td style="text-align:center">${i+1}</td><td>PH b·∫°n</td><td>${d.studentName}</td><td style="text-align:right">${formatMoney(d.amount)}</td></tr>`;
            }).join('');
            html = `
                <div class="header-preview">DANH S√ÅCH ·ª¶NG H·ªò ${camp.name}</div>
                <table class="print-table-preview">
                    <thead><tr><th>STT</th><th>Vai tr√≤</th><th>H·ªç v√† t√™n</th><th>S·ªë ti·ªÅn</th></tr></thead>
                    <tbody>${rows || '<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'}</tbody>
                    <tfoot><tr><th colspan="3" style="text-align:right">T·ªïng c·ªông:</th><th style="text-align:right">${formatMoney(total)}</th></tr></tfoot>
                </table>`;
        } else {
            let list = expenses.filter(e => e.campaignId == cid).sort((a,b) => a.id - b.id);
            let rows = list.map((e, i) => {
                total += e.amount;
                return `<tr><td style="text-align:center">${i+1}</td><td>${e.date||''}</td><td>${e.title}</td><td style="text-align:right">${formatMoney(e.amount)}</td></tr>`;
            }).join('');
            html = `
                <div class="header-preview">DANH S√ÅCH CHI TI√äU ${camp.name}</div>
                <table class="print-table-preview">
                    <thead><tr><th>STT</th><th>Ng√†y</th><th>N·ªôi dung chi</th><th>S·ªë ti·ªÅn</th></tr></thead>
                    <tbody>${rows || '<tr><td colspan="4" style="text-align:center">Ch∆∞a c√≥ d·ªØ li·ªáu chi</td></tr>'}</tbody>
                    <tfoot><tr><th colspan="3" style="text-align:right">T·ªïng chi:</th><th style="text-align:right">${formatMoney(total)}</th></tr></tfoot>
                </table>`;
        }
        document.getElementById('printContent').innerHTML = html;
    }

    function printData() {
        const win = window.open('', '', 'height=700,width=900');
        win.document.write('<html><head><title>In</title>');
        win.document.write('<style>body{margin:20px;font-family:"Times New Roman",serif}table{width:100%;border-collapse:collapse;font-size:13pt}th,td{border:1px solid #000;padding:6px}.header{text-align:center;font-weight:bold;font-size:16pt;margin-bottom:15px;text-transform:uppercase}</style>');
        win.document.write('</head><body>');
        win.document.write(document.getElementById('printContent').innerHTML);
        win.document.write('</body></html>');
        win.document.close();
        win.focus();
        setTimeout(() => { win.print(); win.close(); }, 500);
    }

    function downloadImage() {
        const element = document.getElementById('printContent');
        html2canvas(element, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'danh_sach_' + Date.now() + '.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        });
    }

    function backupData() {
        let data = JSON.stringify({ students, campaigns, donations, expenses });
        let blob = new Blob([data], {type: "text/plain"});
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "saoluu_quy_lop_" + new Date().toLocaleDateString() + ".txt";
        a.click();
    }
    function restoreData() {
        let file = document.getElementById('fileInput').files[0];
        if(!file) return alert("Ch·ªçn file .txt ho·∫∑c .json");
        let reader = new FileReader();
        reader.onload = function(e) {
            try {
                let data = JSON.parse(e.target.result);
                if(confirm("D·ªØ li·ªáu c≈© s·∫Ω b·ªã thay th·∫ø. Ti·∫øp t·ª•c?")) {
                    localStorage.setItem('students', JSON.stringify(data.students || []));
                    localStorage.setItem('campaigns', JSON.stringify(data.campaigns || []));
                    localStorage.setItem('donations', JSON.stringify(data.donations || []));
                    localStorage.setItem('expenses', JSON.stringify(data.expenses || []));
                    location.reload();
                }
            } catch(e) { alert("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng!"); }
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>